---
- hosts: all
  gather_facts: true
  user: sergeyb

  vars:
    mirror: 'http://mirror.switch.ch/ftp/pub/OpenBSD/'
    release: '6.0'
#   https://www.openbsd.org/anoncvs.html
    cvs: 'anoncvs@mirror.osn.de:/cvs'

  tasks:
  - name: add a new user
    user: name=sergeyb comment="Sergey Bronnikov" groups=wheel,wsrc append=yes
    become_method: su
    become: true

  - name: ensure SSH keys are installed
    authorized_key: user=sergeyb key=https://github.com/ligurio.keys
    become_method: su
    become: true

  - name: /etc/doas.conf
    blockinfile:
      dest: /etc/doas.conf
      create: yes
      block: |
        permit nopass keepenv setenv { ENV PS1 SSH_AUTH_SOCK } :wheel
        permit nopass keepenv setenv { ENV PS1 SSH_AUTH_SOCK } :wsrc
    become_method: su
    become: true

  - name: .giconfig
    blockinfile:
      dest: /home/sergeyb/.gitconfig
      create: yes
      block: |
        [user]
                name = Sergey Bronnikov
                email = sergeyb@bronevichok.ru

        [push]
                default = simple

        [color]
                ui = true
    become_method: su
    become: true

  - name: /etc/pkg.conf
    lineinfile:
      dest: /etc/pkg.conf
      line: "installpath = {{ mirror }}/{{ release }}/packages/amd64/"
      regexp: '^'
      state: present
      insertafter: EOF
      create: true
    become_method: su
    become: true

  - name: install packages
    openbsd_pkg: name={{ item }} state=present
    with_items:
        - git
        - gmake
        - the_silver_searcher
        - vim--no_x11
        - py-pip
    become_method: su
    become: true

# pkg_add -D unsigned https://bronevichok.ru/trash/gcovr-3.3.tgz
#  - name: install gcovr
#    command: pkg_add -D unsigned https://bronevichok.ru/trash/gcovr-3.3.tgz
#    become_method: su
#    become: true

  - name: create a directory
    file: path=/home/sergeyb/{{ release }} state=directory

  - name: download release sources {src,ports}.tar.gz
    get_url:
       url: "{{ mirror }}/{{ release }}/{{ item.component }}.tar.gz"
       dest: /home/sergeyb/{{ release }}/
       mode: 0440
       sha256sum: "{{ item.cksum }}"
    with_items:
      - { component: 'src', cksum: 'bcb1cc9fafe2f03ce52455bf07d5cdc90b26ee2550fba1598e938a5fb077b959' }
      - { component: 'sys', cksum: '2e10bf43f5d649a7b58f95c70848ef792fff159affbac5b6c14838cbf4f8b7fa' }
      - { component: 'xenocara', cksum: '55629061d23681ce14141d7d85be991147256395cda3bac3fcb0b718e1a65c60' }
      - { component: 'ports', cksum: '6ebb30084ad4884725eb949134b2c427be04f6db83ce03f4eb20cc3c933ab6f6' }

  - name: checkout OpenBSD sources (src, ports)
    git:
      repo: https://github.com/openbsd/{{ item.component }}
      dest: "{{ item.path }}"
      accept_hostkey: yes
      clone: yes
      update: yes
    with_items:
      - { component: 'src', path: '/usr/src' }
      - { component: 'ports', path: '/usr/ports' }

  - name: make 'wsrc' owner of ports
    file:
      path: /usr/ports
      mode: u=rwX,g=rwX,o=rX
      group: wsrc
      recurse: yes
    become_method: su
    become: true

  # signify -Gns /etc/signify/my-pkg.sec -p /etc/signify/my-pkg.pub
  # cd /usr/ports/packages/$(uname -p)
  # pkg_sign -s signify -s /etc/signify/my-pkg.sec -o signed -S all

  - name: checkout openbsd-wip
    git:
      repo: https://github.com/jasperla/openbsd-wip
      dest: /usr/ports/openbsd-wip
      accept_hostkey: yes
      clone: yes
      update: yes

  - name: add PORTSDIR_PATH and SIGNING_PARAMETERS to /etc/mk.conf
    blockinfile:
      dest: /etc/mk.conf
      content: |
        PORTSDIR_PATH=${PORTSDIR}:$(PORTSDIR)/openbsd-wip:${PORTSDIR}/mystuff
        SIGNING_PARAMETERS=-s signify -s /etc/signify/my-pkg.sec 
      backup: yes
      state: present
      create: True

#  - name: checkout OpenBSD sources from CVS
#    command: CVSROOT={{ cvs }}; cd /usr/ && cvs -d {{ item }} -q up -Pd
#    with_items:
#        - src
#        - sys
#        - xenocara
#        - www
